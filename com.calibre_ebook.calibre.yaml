app-id: com.calibre_ebook.calibre
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: '5.15'
command: calibre
separate-locales: false
finish-args:
  - --device=all
  - --filesystem=host
  - --share=ipc
  - --share=network
  - --socket=x11
  - --system-talk-name=org.freedesktop.NetworkManager
  - --system-talk-name=org.freedesktop.UDisks2
  - --talk-name=org.freedesktop.Notifications
modules:
  - name: calibre
    buildsystem: simple
    build-options:
      env:
        - PODOFO_INC_DIR=/app/include/podofo
        - PODOFO_LIB_DIR=/app/lib
        - XDG_UTILS_INSTALL_MODE=system
    build-commands:
      # Ensure that the used `xdg-utils` will not report errors because they are unable to find any
      # suitable destionation directory to place their files into
      - mkdir -p "${FLATPAK_DEST}"/share/{applications,desktop-directories,icons/hicolor,mime/packages}

      # Compile and install Calibre with all its included binary components (uses xdg-utils)
      - python3 ./setup.py install --prefix="${FLATPAK_DEST}"

      # Rename installed Calibre .desktop files, app icons and appdata XMLs so that Flatpak will not
      # refuse to use them
      - python3 ./fixup-exports.py
    cleanup:
      - /bin/calibre-uninstall
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://download.calibre-ebook.com/5.3.0/calibre-5.3.0.tar.xz
        x-checker-data:
          type: html
          url: https://calibre-ebook.com/download_linux
          version-pattern: The latest release of calibre is ((?:\d+\.)?(?:\d+\.)?\d+)
          url-template: https://download.calibre-ebook.com/$version/calibre-$version.tar.xz
        sha512: e9aacab3d9ff56581d85310ec4cd8a7cd4c80895e368341958693da29ae3a78c4d65f519be96027b1fa59fad909ad0e6684e917c1d035217a4a8e10dd12b075d
        size: 36567444
      - type: patch
        path: calibre-override-sip-target.patch
      - type: patch
        path: calibre-appstream-oars.patch
      - type: patch
        path: calibre-appstream-releases.patch
      - type: file
        path: fixup-exports.py
    modules:
      # Used to build all upstream managed dependencies
      - "deps/bypy/bypy.json"
      # Main dependency list
      - "deps/bypy-generated/flatpak-modules.json"
      # Required for installing Calibre desktop integrations (install-time only)
      - "deps/xdg-utils.json"
      # Additional dependency included in `calibre-appstream-releases.patch`
      - name: PyYAML
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix="${FLATPAK_DEST}"
        cleanup:
          - '*'
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/64/c2/b80047c7ac2478f9501676c988a5411ed5572f35d1beff9cae07d321512c/PyYAML-5.3.1.tar.gz
            sha256: b8eac752c5e14d3eca0e6dd9199cd627518cb5ec06add0de9d32baeee6fe645d
